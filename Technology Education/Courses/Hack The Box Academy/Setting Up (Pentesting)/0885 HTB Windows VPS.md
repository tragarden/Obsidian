# Windows VPS

In most cases #Linux machines are totally viable means of penetration testing, this does not mean however that they are the perfect solution to all of the problems we're investigating. #Windows can be configured and utilized to perform penetration tests just as a Linux machine could be. Advantages to using a Windows machine means better integration with Microsoft technologies like Active Directory and Windows Firewall Defender. Using a Windows machine also offers a level of discretion that a Linux machine doesn't offer - it is easy to recognize an unfamiliar Linux device where a Windows machine would blend in with all the other devices on a corporate network.

Windows Subsystem for Linux ( #WSL) is a modern advent of #Microsoft that allows us to run a Linux operating system ( #OS) in parallel with our choice of Windows OS. This is more efficient than using a Virtual Machine ( #VM) #Hypervisor like VirtualBox or VMWare. 

The following list of applications are useful tools for turning the Windows OS into a pentesting environment:

- Windows Subsystem for Linux ( #WSL)
- Visual Studio Code ( #VSCode)
- #Python 
- #Git 
- #Chocolatey Package Manager.

It is important to consider that installing these applications and performing pentesting related acts are means of exploitation and can be identified by Windows Defender #Firewall as a threat and thusly quarantined and deleted from system storage.

You will need to meet the following bare-minimum #software and #hardware requirements for running a #VM on your Windows machine:

Hardware:

- 1GHz dual-core #processor 
- 2GB #RAM
- 60GB storage
- #Network connection

Software:

- Developer VM for Windows
- Visual Studio 2019 with #UWP
- .NET Desktop
- Azure Workflows enabled
- Windows Template Studio extension
- Visual Studio Code
- Windows Subsystem for Linux
- Ubuntu
- Developer Mode enabled

 Core Changes:

- Creating a system backup point to revert to during restoration
- Update all aspects of your hardware and software
- Install #WSL and #Chocolatey 
- Windows Defender exclusions

Most of the above changes can be managed through Windows #PowerShell with Administrator privileges. 

#### Updates

To install necessary updates to your Windows host, use the following command:

> Get-ExecutionPolicy -List

#### Execution Policy

This will reveal a list of the current policies set for the machine. We will be making temporary changes to the policies within this scope - therefore Execution Policy changes will be managed within the scope of #Process:

>Set-ExecutionPolicy Unrestricted -Scope Process
>Get-ExecutionPolicy -List

We have now successfully changed the Policy for the scope Process - this is the way to change policies temporarily. 

#### PSWindowsUpdate

Now we will install PSWindowsUpdate for more convenient updating:

> Install-Module PSWindowsUpdate

Now we import this module and update it with the following command:

>Import-Module PSWindowsUpdate
>Install-WindowsUpdate AcceptAll
>Restart-Computer -Force

We now have a convenient means of updating our system from the command line ( #CLI). Updates should be performed regularly and often as outdated versions can expose vulnerabilities.

#### Chocolatey

#Chocolatey is a #FOSS package manager that allows for scripted automation via #PowerShell and #Ansible. This applications lets us download tools from a single source instead of seeking each tool individually from their respective developer.

Use the following commands to install Chocolatey and related tools:

This command installs Chocolatey after changing the related Execution Policy:

>Set-Execution Policy Bypass -Scope Process -Force; \[System.Net.ServicePointManager]::SecurityProtocol -bor 3072; iex ((New-Object System.Net.WebClient).DownloadString('\https://chocolatey.org/install.ps1'))

Next we will update Chocolatey and install related packages:

>choco upgrade chocolatey -y

Now we can use the command 'choco' to install multiple packages simultaneously. This can be done by including the name of any package you desire separated by a space.

To learn about the package for VSCode, use the following:

> choco info vscode

To install #Python, #vscode, #git, #WSL, #SSH, and #OpenVPN:

>choco install python vscode git wsl2 openssh openvpn
>RefreshEnv

The first line will download the intended packages and any dependencies they need to run.
The second line will update PowerShell and any related dependencies.

#### Windows Teminal

The Windows #Terminal is used to emulate multiple command-line interfaces simultaneously. It is designed to handle commands for Command Prompt ( #cmd), PowerShell ( #PS), and Windows Subsystem for Linux ( #WSL). This application will allows you to manipulate multiple command lines at the same time.

Use the following command in PowerShell to install Windows Terminal:

>choco install microsoft-windows-terminal


#### WSL2

Windows Subsystem for Linux 2 ( #WSL2) facilitates the use of #Linux, #Vim, #Python, and other languages that are not typically supported by Windows devices. This DOES NOT use a #Hypervisor and instead offers a hybrid environment that supports both Windows and Linux related software.

Install WSL2 with the following command:

>choco install WSL2

WSL2 for Windows will support the following Linux-based operating systems:

- Ubuntu
- openSUSE Leap
- SUSE Linux Enterprise Server
- Kali Linux
- Debian GNU
- Fedora Remix
- Pengwin
- Pengwin Enterprise
- Alpine WSL

After installing your sub-system of choice, open PowerShell and enter the command 'bash':

>bash

This will allow us to begin using the newly installed OS.

#### Configuring Defender

Since Windows Defender and associated Firewall will identify and remove exploitative applications and code, we need to configure our security system to exclude our tools from their blacklists. You will need to make exclusions for the following folders:

C:\\Users\\User321654\\AppData\\Local\\Temp\\chocolatey\\
C:\\Users\\User654321\\Documents\\git-repos
C:\\Users\\User654321\\Documents\\scripts\\

We can exclude these folders with the following command:

>Add-MpPreference -ExclusionPath "C:\\Users\\User654321\\AppData\\Local\\Temp\\chocolatey"
>Add-MpPreference -ExclusionPath "C:\\Users\\User654321\\Documents\\git-repos\\"
>Add-MpPreference -ExclusionPath "C:\\Users\\User654321\\Documents\\scripts\\"


Take note of any additional folders that you create or download to, as they will need to be excluded as well.

#### Automating Installations

Chocolatey allows us to use PowerShell scripts to automate the installation of packages in a single command. These scripts can be modified for different purposes and platforms. The execution policy must be modified before these scripts can be successfully implemented. 

Here is an example from HackTheBox Academy of a Chocolatey build script for PowerShell that installs and updates a set of packages while also supplying prompts for the process:

> # Choco Build Script
> write-host "\*\*\* Initial app install for core tools and packages. \*\*\*"
> 
> write-host "\*\*\* Configuring chocolatey \*\*\*"
> choco feature enable -n allowGlobalConfirmation
>
>write-host "\*\*\* Beginning Install, this will take a few minutes. \*\*\*"
>choco upgrade wsl2 python git vscode openssh openvpn netcat nmap wireshark burp-suite-free-edition heidisql sysinternals putty golang neo4j-community openjdk
>
>write-host "\*\*\* Build complete, restoring GlobalConfirmation policy. \*\*\*"
>choco feature disable -n allowGlobalConfirmation

Note the following rules of thumb:

- Use the command choco or choco.exe - you can alternatively use cup or cinst but these can cause problems when you are scripting.
- Use the full extension name instead of a single letter flag. Use '--name' instead of '-n'.
- Do not use --force within scripts as this can break the function of chocolatey.

#### Git Clone

While Chocolatey can be used to gather many of the tools we need, some will only be available through GitHub. Luckily we can also automate this process for our convenience. Writing a Git script is similar to writing a script for chocolatey.

We will examine the example command for cloning a repository:

>git clone https://github.com/dafthack/DomainPasswordSpray.git

#### Other VMs

If you want to install an older and outdated version of Windows, you can do so with the following tools:

- Chocolatey
- MediaCreationTool.bat
- Microsoft Windows and Office ISO Download Tool
- Rufus

