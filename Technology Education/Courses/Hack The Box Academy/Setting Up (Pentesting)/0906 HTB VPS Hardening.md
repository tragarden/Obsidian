# VPS Hardening

#Hardening is the concept of identifying any vulnerabilities or points of exploitation within our #network and eliminating them. This follows a standard set of practices that ensure all facets of the network are considered and evaluated for security. For instance, with our Virtuaal Private Server ( #VPS) we should restrict access from all remote access methods except for the method we have already set up - #SSH.

HTB Suggests the following list for basic hardening methods:

- Install the application #Fail2ban.
- Only use #SSH if that is the route you have chosen.
- Use a small window of time for inactivity - lock the system during idle sooner rather than later.
- Disable password entry.
- Disable x11 forwarding.
- Use a different port than the assigned default port.
- Limit what users are able to access SSH.
- Disable login from root account.
- Use SSH Proto 2.
- Enable #2FA Authentication for SSH access.

It is likely that you will be unfamiliar with a few or all of these steps. When learning how to implement these ideas, try configuring them in a local Virtual Machine ( #VM) before you implement them within your VPS.

#### Updating

Updating all hardware, firmware, and software is important for security purposes. This ensures that all aspects of your system are current, which means they will be in the most seamless state of operation with as many security threats addressed and patched as possible. 

Use the following command to update the different aspects of your system:

> sudo apt update -y && sudo apt full-upgrade -y && sudo apt autoremove -y && sudo apt autoclean -y

### Hardening Methods

During this part of the process we will need to modify the file /etc/ssh/sshd_config, which is the configuration file for SSH. Within this file are many settings that allow for granular control of the SSH interface. The manual page for SSH will show you a full list of the configurable settings for SSH. [SSH Manual Page for Linux](https://man.openbsd.org/sshd_config "The manual page for SSH"). 

Before we can configure this file however, we need to install and configure Fail2ban.

#### Installing Fail2ban

We can install Fail2ban with the following command:

> sudo apt install fail2ban -y

You can now find the configuration file for fail2ban within /etc/fail2ban/jail.conf.

You will want to create backups for your fail2ban configurations. We can do so with the following:

> sudo cp /etc/fail2ban/jail.conf /etc/fail2ban/jail.conf.bak

Within this file will be fields that are commented out. We are seeking the field # \[sshd] - it should be the first one but this is not always the case. It should appear as below:

> # \[sshd]
> enabled = true
> bantime = 4w
> maxretry = 3

This means that the system will now monitor login attempts and any #IP that performs 3 failed attempts at accessing the SSH system will be banned for 4 weeks.

#### Configuring SSH

Now we will need to make configuration changes in the /etc/ssh/sshd_config file via the following commands:

> sudo cp /etc/ssh/sshd_config /etc/ssh/sshd_config.bak
> sudo vim /etc/ssh/sshd_config

The sshd_config file contains a lot of different variables that you can adjust and tweak. Most are self explanatory, although some may be unfamiliar. The detailed explanation of these configuration settings is beyond the scope of what I feel like writing right now.

#### 2FA Authentication

#2FA #Authentication can be added to our #SSH configurations to further harden our SSH interfaces. In the case of this module, we will use #Goolge Authenticator to generate a One-Time Password ( #OTP). This is the preferred method because it ensure that you will use 2FA to access Google authenticator AND the 2FA for SSH as well. Google Authenticator will generate the password that will be accessible on your mobile devices.

#### PAM Module

To configure 2FA with Google Authenticator with our VPS, we must install the Google-Authenticator Pluggable Authentication Module ( #PAM ).

Install and Configure Google-Authenticator PAM Module with the following command:

> sudo apt install libpam-google-authenticator -y
> google-authenticator

Once we submit 'yes', the terminal will provide with both a #QR code and a secret key.

After we access the QR code or submit our secret key, Google Authenticator will provide us with our six-digit One-Time Password ( #OTP). You can then submit this code via terminal to authorize and synchronize our session. 

Emergency Scratch Codes will then be provided as backup codes in case we lose our device that hosts the Google-Authenticator.

#### PAM Module Configuration

We must configure the PAM module to be compatible with the #SSH Daemon. Begin by backing up the PAM files via text editor:

> sudo cp /etc/pam.d/sshd /etc/pam.d/sshd.bak
> sudo vim /etc/pam.d/sshd

Once we are editing the file, we need to comment our the line "\@include common-auth" as follows:

> #\[Invalid date](Invalid date)

>...SNIP...

>auth required pam_google_authenticator.so
>auth required pam_permit.so

#### SSH Daemon Configuration

Our SSH Daemon does not allow this authentication by default - it must be configured by adding to the end of the file we just modified:

>AuthenticationMethods publickey,keyboard-interactive
>PasswordAuthentication no

Now you will restart the SSH server with the following command:

>sudo service ssh restart

Try to log in with our SSH key after restart:

>ssh USERNAME -i ~/.ssh.vps-ssh

Enter your password and Google Authenticator code, which should yield access.

#### SCP

Secure Copy Protocol ( #SCP) can be used to transfer any content, scripts, or resources to the VPS. 

We can do so with the following command:

> scp -i \<ssh-private-key> -r \<transfer-directory-destination> \<USERNAME>\@\<IP/FQDN>:\<PATH>

To transfer resources:

> scp -i ~/.ssh/vps-ssh -r ~/Pentesting USERNAME\@VPS:\~\/

### Related:

- [SSH Manual Page for Linux](https://man.openbsd.org/sshd_config "The manual page for SSH")